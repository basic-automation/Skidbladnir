<html>
  <head>
    <title>ba | Next Generation Images</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline'">
    <link rel="stylesheet" href="index.css">
  </head>
  <body>
    <header><h1><span class="semi-2">nextGen |</span><span> &nbsp;Webp</span></h1></header>
    <form id="convert" onsubmit="">
      <div class="row-subheader">
        <div class="container-2">
          <div class="input-container">
            <input type="file" id="inputPath">
            <button class="input-browse-btn">
              Input File
            </button>
            <span class="input-File-info" id="input-file-info">Select a file</span>
            <span class="tooltip"><img src="./resources/images/info.svg" class="info"><span class="tooltiptext">Select an image file to compress to a WebP file. Only .png, .jpg, .tiff, & .webp formats accepted.</span></span>
          </div>
          <span class="submition-error" id="inputError"></span>
        </div>
        <div class="container-2">
          <div class="input-container">
            <input type="file" id="outputPath" webkitdirectory directory>
            <button class="output-browse-btn">
              Output Directory
            </button>
            <span class="output-file-info" id="output-file-info">Select a Directory</span>
          </div>
          <span class="submition-error" id="outputError"></span>
        </div>
        <div class="container-0">
          <div class="advanced" id="advanced">
            <div class="options visible toggleAdvanced" onclick="optionsClick()">--- Advanced Options ---</div>
            <div class="group-1 options">
              <div><h2>Mode</h2></div>
              <div class="subcontainer-5 inactive">
                <label class="radioContainer">JPEG Like
                  <input type="radio" name="mode" value="jpegLike" disabled="true">
                  <span class="radioCheckmark"></span>
                </label>
              </div>
              <div class="subcontainer-5">
                <label class="radioContainer">Lossy
                  <input type="radio" checked="checked" name="mode" value="lossy" id="modeLossy">
                  <span class="radioCheckmark"></span>
                </label>
              </div>
              <div class="subcontainer-5">
                <label class="radioContainer">Lossless
                  <input type="radio" name="mode" value="lossless" id="modeLossless">
                  <span class="radioCheckmark"></span>
                </label>
              </div>
              <div class="subcontainer-5 inactive">
                <label class="radioContainer">Near Lossless
                  <input type="radio" name="mode" value="nearLossless" disabled="true">
                  <span class="radioCheckmark"></span>
                </label>
              </div>
              <div class="subcontainer-5 inactive">
                <label class="radioContainer">Preset
                  <input type="radio" name="mode" value="preset" disabled="true">
                  <span class="radioCheckmark"></span>
                </label>
              </div>
            </div>
            <div class="group-1 options">
              <h2>Quality</h2>
              <div class="container-1 options">
                <div class="advanced-container">
                  <button class="quality-btn">
                    Quality:
                  </button>
                  <span class="quality-info" id="quality-info">75</span>
                </div>
                <input type="range" id="quality" min="0" max="100" value="75">
              </div>
              <div id="alphaQuality-container" class="container-2 options">
                <div class="advanced-container">
                  <button class="alphaQuality-btn">
                    Transparency Quality:
                  </button>
                  <span class="alphaQuality-info" id="alphaQuality-info">100</span>
                </div>
                <input type="range" id="alphaQuality" min="0" max="100" value="100">
              </div>
              <div class="container-2 options">
                <div class="advanced-container">
                  <button class="cMethod-btn">
                    Compression Method:
                  </button>
                  <span class="cMethod-info" id="cMethod-info">4</span>
                </div>
                <input type="range" id="cMethod" min="0" max="6" value="4">
              </div>
            </div>
            <div id="lossyOptions" class="group-1 options">
              <h2>Lossy Options</h2>
              <div id="lossyFilterOptions" class="group-1 options">
                <h2>Compression</h2>
                <div class="container-1">
                  <div class="subcontainer-5">
                    <label class="radioContainer">File Size
                      <input id="compressionFS" type="radio" checked="checked" name="compression" value="auto">
                      <span class="radioCheckmark"></span>
                    </label>
                  </div>
                  <div class="subcontainer-5">
                    <label class="radioContainer">Peak Signal to Noise Ratio
                      <input id="compressionPSNR" type="radio" name="compression" value="auto">
                      <span class="radioCheckmark"></span>
                    </label>
                  </div>
                </div>
                <div class="container-2 options">
                  <div class="advanced-container">
                    <button class="targetSize-btn">
                      Target Size:
                    </button>
                    <div class="numberContainer"><input type="number" id="targetSize" min="1" step="1" value="1"> bytes </div><br>
                    <button class="btn" id="originalSize">(original)</button>
                  </div>
                </div>
                <div  id="PSNR-container" class="container-2 options inactive">
                  <div class="advanced-container">
                    <button class="targetPSNR-btn">
                      Target PSNR (dB):
                    </button>
                    <span class="targetPSNR-info" id="targetPSNR-info">10000</span>
                  </div>
                  <input type="range" id="targetPSNR" step="1" min="1" max="10000" value="10000" disabled>
                </div>
                <div  id="passes-container" class="container-1 options">
                  <div class="advanced-container">
                    <button class="passes-btn">
                      Number of Passes:
                    </button>
                    <span class="passes-info" id="passes-info">6</span>
                  </div>
                  <input type="range" id="passes" step="1" min="1" max="10" value="6">
                </div>
              </div>
              <div id="lossyFilterOptions" class="group-1 options">
                <h2>Deblocking Filter Options</h2>
                <div class="container-1">
                  <div class="subcontainer-5">
                    <label class="radioContainer">Auto Filter
                      <input id="filterAuto" type="radio" checked="checked" name="filterType" value="auto">
                      <span class="radioCheckmark"></span>
                    </label>
                  </div>
                  <div class="subcontainer-5">
                    <label class="radioContainer">Strong Filter
                      <input id="strongFilterCustom" type="radio" name="filterType" value="strong">
                      <span class="radioCheckmark"></span>
                    </label>
                  </div>
                  <div class="subcontainer-5">
                    <label class="radioContainer">Simple Filter
                      <input id="simpleFilterCustom" type="radio" name="filterType" value="simple">
                      <span class="radioCheckmark"></span>
                    </label>
                  </div>
                </div>
              <div id="filterStrengthContainer" class="container-2 options inactive">
                <div class="advanced-container">
                  <button class="filterStrength-btn">
                    Strength:
                  </button>
                  <span class="filterStrength-info" id="filterStrength-info">20</span>
                </div>
                <input type="range" id="filterStrength" min="0" max="100" value="20" disabled="true">
              </div>
              <div id="filterSharpContainer" class="container-2 options inactive">
                <div class="advanced-container">
                  <button class="filterSharp-btn">
                    Sharpness:
                  </button>
                  <span class="filterSharp-info" id="filterSharp-info">0</span>
                </div>
                <input class="reversedInput" type="range" id="filterSharp" min="0" max="7" value="0" disabled="true">
              </div>
            </div>
            <div id="lossyNoiseOptions" class="group-1 options">
              <h2>Noise Shaping</h2>
              <div class="container-2 options">
                <div class="advanced-container">
                  <button class="sns-btn">
                    Amplitude:
                  </button>
                  <span class="sns-info" id="sns-info">50</span>
                </div>
                <input type="range" id="sns" min="0" max="100" value="50">
              </div>
              <div class="container-2 options">
                <div class="advanced-container">
                  <button class="segments-btn">
                    Number of Segments:
                  </button>
                  <span class="segments-info" id="segments-info">4</span>
                </div>
                <input class="reversedInput" type="range" id="segments" min="1" max="4" value="4">
              </div>
            </div>
          </div>
        </div>
        <div class="container-submit">
          <button class="fab" id="fab" type="submit"><img id="fabImg" class="submit" width="35px" style="transition: opacity 500ms linear; opacity: 1;" src="./resources/images/thumbs-up.svg"></button>
        </div>
    </form>
    <div class="footSpacer"></div>
    <div class="container" style="position:relative;">
      <footer></footer>
    </div>
  </body>

  <script>
    /**********************/
    // Define Constants
    /**********************/
    const electron = require('electron');
    const { ipcRenderer } = electron;
    const path = require('path');
    const fileBytes = require('file-bytes');
    const form = document . querySelector('form');
    const inputUploadButton = document.querySelector('.input-browse-btn');
    const inputFileInfo = document.querySelector('.input-File-info');
    const realInput = document.getElementById('inputPath');
    const outputUploadButton = document.querySelector('.output-browse-btn');
    const outputFileInfo = document.querySelector('.output-file-info');
    const realOutput = document.getElementById('outputPath');
    const submit = document.querySelector('.fab');
    const quality = document.getElementById('quality');
    const alphaQuality = document.getElementById('alphaQuality');
    const cMethod = document.getElementById('cMethod');
    const segments = document.getElementById('segments');
    const targetSize = document.getElementById('targetSize');
    const sns = document.getElementById('sns');
    const modeLossless = document.getElementById('modeLossless');
    const lossyOptions = document.getElementById('lossyOptions');
    const modeLossy = document.getElementById('modeLossy');
    const filterAuto = document.getElementById('filterAuto');
    const strongFilterCustom = document.getElementById('strongFilterCustom');
    const simpleFilterCustom = document.getElementById('simpleFilterCustom');
    const filterStrength = document.getElementById('filterStrength');
    const filterSharp = document.getElementById('filterSharp');
    const targetPSNR = document.getElementById('targetPSNR');
    const compressionFS = document.getElementById('compressionFS');
    const compressionPSNR = document.getElementById('compressionPSNR');
    const passes = document.getElementById('passes');

    var inputPath = "";
    var outputPath = "";
    var advanced = false;
    var appMode = "lossy";
    var isAF = "auto";
    var compressionType = "fileSize";

    /**********************/
    // event listeners 
    /**********************/
    // Listen for the vanity input file button to be clicked.
    // Then fire the input file box click event.
    inputUploadButton.addEventListener('click', () => {
      realInput.click();
    });


    // Listen for a change in the value of the input file box.
    // Then change the vanity input box value to match.
    realInput.addEventListener('change', () => {
      console.log("input changed");
      const name = realInput.value.split(/\\|\//).pop();
      const truncated = name.length > 20 
        ? name.substr(name.length - 20) 
        : name;
        inputFileInfo.innerHTML = truncated;

      ipcRenderer.sendSync('fileSize', document.querySelector('#inputPath').files[0].path);
      var filesize = ipcRenderer.sendSync('fileSize', document.querySelector('#inputPath').files[0].path);
      console.log('File Size: '+filesize);
      document.getElementById('originalSize').textContent = filesize+' bytes (original)';
      document.getElementById('targetSize').value = filesize;

      ipcRenderer.sendSync('maxPSNR', document.querySelector('#inputPath').files[0].path);
      var returnPSNR = ipcRenderer.sendSync('maxPSNR', document.querySelector('#inputPath').files[0].path);
      returnPSNR = parseInt(returnPSNR*1.2);
      console.log("Returned PSNR: "+returnPSNR);
      targetPSNR.setAttribute("max", returnPSNR.toString());
      targetPSNR.value = returnPSNR;
      document.getElementById('targetPSNR-info').textContent = returnPSNR;
    });


    // Listen for the vanity output file button to be clicked.
    // This fire the output file box click event.
    outputUploadButton.addEventListener('click', () => {
      realOutput.click();
    });

    modeLossless.addEventListener('change', () => {
      document.getElementById('alphaQuality-info').innerHTML = "100";
      alphaQuality.value = 100;
      document.getElementById('alphaQuality-container').className = "container-2 options inactive";
      disableLossy();
      hideLossy();
      appMode = "lossless";
    });

    modeLossy.addEventListener('change', () => {
      document.getElementById('alphaQuality-container').className = "container-2 options";
      enableLossy();
      unHideLossy();
      appMode = "lossy";
    });

    function disableLossy(){
      alphaQuality.setAttribute('disabled', 'true');
      segments.setAttribute('disabled', 'true');
      targetSize.setAttribute('disabled', 'true');
      sns.setAttribute('disabled', 'true');
    }

    function enableLossy(){
      alphaQuality.removeAttribute('disabled');
      segments.removeAttribute('disabled');
      targetSize.removeAttribute('disabled')
      sns.removeAttribute('disabled');
    }

    function hideLossy(){
      lossyOptions.style.display = "none";
    }

    function unHideLossy(){
      lossyOptions.style.display = "inline-block";
    }

    filterAuto.addEventListener('change', () => {
      disableCustomFilter();
      isAF = "auto";
    });

    strongFilterCustom.addEventListener('change', () => {
      enableCustomFilter();
      isAF = "strong";
    });

    simpleFilterCustom.addEventListener('change', () => {
      enableCustomFilter();
      isAF = "simple";
    });

    compressionFS.addEventListener('change', () => {
      document.getElementById('PSNR-container').className = "container-2 options inactive";
      targetPSNR.setAttribute('disabled', 'true');
      compressionType = "fileSize";
    });

    compressionPSNR.addEventListener('change', () => {
      document.getElementById('PSNR-container').className = "container-2 options";
      targetPSNR.removeAttribute('disabled');
      compressionType = "PSNR";
    });

    function disableCustomFilter(){
      filterStrength.setAttribute('disabled', 'true');
      document.getElementById('filterStrengthContainer').className = "container-2 options inactive";

      filterSharp.setAttribute('disabled', 'true');
      document.getElementById('filterSharpContainer').className = "container-2 options inactive";
    }

    function enableCustomFilter(){
      filterStrength.removeAttribute('disabled');
      document.getElementById('filterStrengthContainer').className = "container-2 options";

      filterSharp.removeAttribute('disabled');
      document.getElementById('filterSharpContainer').className = "container-2 options";
    }

    filterStrength.addEventListener('change', () => {
      document.getElementById('filterStrength-info').textContent = filterStrength.value.toString();
    });

    filterSharp.addEventListener('change', () => {
      document.getElementById('filterSharp-info').textContent = filterSharp.value.toString();
    });

    targetPSNR.addEventListener('change',()=>{
      document.getElementById('targetPSNR-info').textContent = targetPSNR.value.toString();
    });

    passes.addEventListener('change',()=>{
      document.getElementById('passes-info').textContent = passes.value.toString();
    });



    // Listen for a change in the value of the output file box.
    // Then change the vanity output box value to match.

    realOutput.addEventListener('change', () => {
      const name = realOutput.value.split(/\\|\//).pop();
      const truncated = name.length > 20 
        ? name.substr(name.length - 20) 
        : name;
        outputFileInfo.innerHTML = truncated;
    });

    quality.addEventListener('change',()=>{
      document.getElementById('quality-info').textContent = quality.value.toString();
    });

    alphaQuality.addEventListener('change',()=>{
      document.getElementById('alphaQuality-info').textContent = alphaQuality.value.toString();
    });

    cMethod.addEventListener('change',()=>{
      document.getElementById('cMethod-info').textContent = cMethod.value.toString();
    });

    segments.addEventListener('change',()=>{
      document.getElementById('segments-info').textContent = segments.value.toString();
    });

    sns.addEventListener('change',()=>{
      document.getElementById('sns-info').textContent = sns.value.toString();
    });

    // Listen for form submition
    submit.addEventListener('click', submitForm); 
    form.addEventListener('submit', prevent);
    function prevent(e){
      e.preventDefault();
      console.log("form submit");
    }

    // Detect call to ipcRenderer and log sent data to console
    ipcRenderer.on('consoleSend',function(e,consoleSend){
      console.log(consoleSend);
    });


    /**********************/
    // establish connection to main.js 
    /**********************/

    // Send identifier to establish relationship with main.js
    ipcRenderer.send('indentifier', "index.html");


    /**********************/
    // form submition functions
    /**********************/
    // On form submition send collected data to main.js
    function submitForm(e){

      // Prevent default handling of form submition
      e.preventDefault();


      // Load collected data into variables
      //var inputPath = document.querySelector('#inputPath').files[0].path;
      //var outputPath = document.querySelector('#outputPath').files[0].path;

      if(formCheck()){
        // Send collected data to main.js for processing
        ipcRenderer.send('inputPath', inputPath); 
        console.log('Advanced:'+advanced.toString());
        if(advanced){
          if(appMode == "lossless"){
            console.log('Mode: Lossless');
            ipcRenderer.send('lossless', 'true');
            ipcRenderer.send('quality', quality.value.toString());
            ipcRenderer.send('alphaQuality', alphaQuality.value.toString());
            ipcRenderer.send('cMethod', cMethod.value.toString());
          }
          else if(appMode == "lossy"){
            console.log("Mode: Lossy");
            ipcRenderer.send('quality', quality.value.toString());
            ipcRenderer.send('alphaQuality', alphaQuality.value.toString());
            ipcRenderer.send('cMethod', cMethod.value.toString());
            ipcRenderer.send('segments', segments.value.toString());
            ipcRenderer.send('passes', passes.value.toString());
            if(compressionType == "fileSize"){
              ipcRenderer.send('targetSize', targetSize.value.toString());
            } else {
              ipcRenderer.send('PSNR', targetPSNR.value.toString());
            }
            ipcRenderer.send('sns', sns.value.toString());
            ipcRenderer.send('isAF', isAF);
            if(isAF == "simple" || isAF == "strong"){
              ipcRenderer.send('filterStrength', filterStrength.value.toString());
              ipcRenderer.send('filterSharp', filterSharp.value.toString());
            }
          }
        }
        ipcRenderer.send('outputPath', outputPath);
        isconvertComplete();
        formReset(appMode);
      }
    }

    function formReset(mode){
      if(mode == "lossy"){
        document.getElementById('inputPath').value = "";
        document.getElementById('input-file-info').textContent = "Select a file";
        //document.getElementById('outputPath').value = "";
        //document.getElementById('output-file-info').textContent = "Select a directory";
        document.getElementById('fabImg').style.opacity = 0;
      }
      if(mode == "lossless"){
        document.getElementById('inputPath').value = "";
        document.getElementById('input-file-info').textContent = "Select a file";
        //document.getElementById('outputPath').value = "";
        //document.getElementById('output-file-info').textContent = "Select a directory";
        //document.getElementById('fabImg').style.opacity = 0;
      }
    }

    function formCheck(){
      document.getElementById('inputError').textContent = "";
      document.getElementById('outputError').textContent = "";
      try{
        inputPath = document.querySelector('#inputPath').files[0].path;
      }catch{
        console.error("Error: Missing input selection.");
        document.getElementById('inputError').textContent = "Error: Missing input selection.";
        return false;
      }
      var inputExt = path.extname(inputPath).toUpperCase();
      if((inputExt == ".PNG" || inputExt == ".JPG" || inputExt == ".JPEG" || inputExt == ".JPE" || inputExt == ".Jif" || inputExt == ".JFIF" || inputExt == ".JFI" || inputExt == ".TIF" || inputExt == ".TIFF" || inputExt == ".WEBP")){
        try{
          outputPath = document.querySelector('#outputPath').files[0].path;
        }
        catch{
          console.error("Error: Missing input selection.");
          document.getElementById('outputError').textContent = "Error: Missing output selection.";
          return false;
        }
          return true;
      }
      else{
        document.getElementById('inputError').textContent = "Error: Invalid input file type (JPEG, PNG, TIFF, WebP).";
        console.log("Error: Wrong input file type.");
        return false;
      }
      return false;
    }

    async function isconvertComplete(){
      ipcRenderer.sendSync('isConverted', 'webp');

      var j = 0;
      var k = 10;
      var isconverted = ipcRenderer.sendSync('isConverted', 'webp').toString();
      console.log("Completion Code: "+isconverted);

        if(isconverted == '0'){
          setTimeout(function(){
            console.log("Animation 1");
            document.getElementById('fabImg').src = './resources/images/check-mark.svg';
            document.getElementById('fabImg').style.opacity = "1";
            document.getElementById('fab').style.backgroundColor = 'rgba(71,171,108)';
          }, 500);

          setTimeout(function(){ 
            console.log("Animation 2");
            document.getElementById('fabImg').style.opacity = "0";
          }, 2500);  

          setTimeout(function(){
            console.log("Animation 3");
            document.getElementById('fabImg').src = './resources/images/thumbs-up.svg';
            document.getElementById('fabImg').style.opacity = "1";
            document.getElementById('fab').style.backgroundColor = 'rgba(71,171,108)';
          }, 3000);
        }
        else
        {
          console.log("Animation Else");
          document.getElementById('fab').style.backgroundColor = red;
        }
        ipcRenderer.send('clear', "webp");
    }

    function optionsClick(){
      if(advanced){advanced = false;}else{advanced=true;}
      var i = 1;
      if(document.getElementsByClassName('options')[0].textContent == '--- Advanced Options ---'){
        document.getElementsByClassName('options')[0].textContent = "--- Basic ---";
        do{
          document.getElementsByClassName('options')[i].style.display = 'inline-block';
          i++;
        }while(i < document.getElementsByClassName('options').length);
      }
      else{
        document.getElementsByClassName('options')[0].textContent = "--- Advanced Options ---";
        do{
          document.getElementsByClassName('options')[i].style.display = 'none';
          i++;
        }while(i < document.getElementsByClassName('options').length);
      }
    }
  </script>
</html>